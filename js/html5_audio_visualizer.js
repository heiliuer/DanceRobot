var Visualizer=function(){this.file=null,this.fileName=null,this.audioContext=null,this.source=null,this.info=document.getElementById("info").innerHTML,this.infoUpdateId=null,this.animationId=null,this.status=0,this.forceStop=!1,this.allCapsReachBottom=!1};Visualizer.prototype={ini:function(){this._prepareAPI(),this._addEventListner()},_prepareAPI:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;try{this.audioContext=new AudioContext}catch(t){this._updateInfo("!Your browser does not support AudioContext",!1),console.log(t)}},_addEventListner:function(){var t=this,e=document.getElementById("uploadedFile"),n=document.getElementsByTagName("canvas")[0];e.onchange=function(){null!==t.audioContext&&0!==e.files.length&&(t.file=e.files[0],t.fileName=t.file.name,1===t.status&&(t.forceStop=!0),document.getElementById("fileWrapper").style.opacity=1,t._updateInfo("Uploading",!0),t._start())},n.addEventListener("dragenter",function(){document.getElementById("fileWrapper").style.opacity=1,t._updateInfo("Drop it on the page",!0)},!1),n.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"},!1),n.addEventListener("dragleave",function(){document.getElementById("fileWrapper").style.opacity=.2,t._updateInfo(t.info,!1)},!1),n.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),null!==t.audioContext&&(document.getElementById("fileWrapper").style.opacity=1,t._updateInfo("Uploading",!0),t.file=e.dataTransfer.files[0],1===t.status&&(document.getElementById("fileWrapper").style.opacity=1,t.forceStop=!0),t.fileName=t.file.name,t._start())},!1)},_start:function(){var t=this,e=this.file,n=new FileReader;n.onload=function(e){var n=e.target.result,i=t.audioContext;null!==i&&(t._updateInfo("Decoding the audio",!0),i.decodeAudioData(n,function(e){t._updateInfo("Decode succussfully,start the visualizer",!0),t._visualize(i,e)},function(e){t._updateInfo("!Fail to decode the file",!1),console.log(e)}))},n.onerror=function(e){t._updateInfo("!Fail to read the file",!1),console.log(e)},this._updateInfo("Starting read the file",!0),n.readAsArrayBuffer(e)},_visualize:function(t,e){var n=t.createBufferSource(),i=t.createAnalyser(),o=this;this.audioBufferSouceNode=n,n.connect(i),i.connect(t.destination),n.buffer=e,n.start||(n.start=n.noteOn,n.stop=n.noteOff),null!==this.animationId&&cancelAnimationFrame(this.animationId),null!==this.source&&this.source.stop(0),n.start(0),this.status=1,this.source=n,n.onended=function(){o._audioEnd(o)},this._updateInfo("Playing "+this.fileName,!1),this.info="Playing "+this.fileName,document.getElementById("fileWrapper").style.opacity=.2,this._drawSpectrum(i)},getAudioBufferSouceNode:function(){return this.audioBufferSouceNode},_drawSpectrum:function(t){var e=this,n=document.getElementById("canvas"),i=n.width,o=n.height-2,a=10,r=2,d="#fff",u=800/12,l=[];ctx=n.getContext("2d"),gradient=ctx.createLinearGradient(0,0,0,300),gradient.addColorStop(1,"#0f0"),gradient.addColorStop(.5,"#ff0"),gradient.addColorStop(0,"#f00");var s=function(){i=n.width,o=n.height-2;var f=new Uint8Array(t.frequencyBinCount);if(t.getByteFrequencyData(f),e.handlerBuffer&&e.handlerBuffer(f),0===e.status){for(var c=f.length-1;c>=0;c--)f[c]=0;allCapsReachBottom=!0;for(var c=l.length-1;c>=0;c--)allCapsReachBottom=allCapsReachBottom&&0===l[c];if(allCapsReachBottom)return void cancelAnimationFrame(e.animationId)}var m=Math.round(f.length/u);ctx.clearRect(0,0,i,o);for(var c=0;c<u;c++){var p=f[c*m];l.length<Math.round(u)&&l.push(p),ctx.fillStyle=d,p<l[c]?ctx.fillRect(12*c,o- --l[c],a,r):(ctx.fillRect(12*c,o-p,a,r),l[c]=p),ctx.fillStyle=gradient,ctx.fillRect(12*c,o-p+r,a,o)}e.animationId=requestAnimationFrame(s)};this.animationId=requestAnimationFrame(s)},_audioEnd:function(t){if(this.forceStop)return this.forceStop=!1,void(this.status=1);this.status=0;var e="HTML5 Audio API showcase | An Audio Viusalizer";document.getElementById("fileWrapper").style.opacity=1,document.getElementById("info").innerHTML=e,t.info=e,document.getElementById("uploadedFile").value=""},_updateInfo:function(t,e){var n=document.getElementById("info"),i="...",o=0,a=this;if(n.innerHTML=t+i.substring(0,o++),null!==this.infoUpdateId&&clearTimeout(this.infoUpdateId),e){var r=function(){o>3&&(o=0),n.innerHTML=t+i.substring(0,o++),a.infoUpdateId=setTimeout(r,250)};this.infoUpdateId=setTimeout(r,250)}}};